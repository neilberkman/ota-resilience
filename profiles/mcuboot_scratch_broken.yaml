schema_version: 1
name: mcuboot_scratch_broken
description: "MCUboot swap-using-SCRATCH BEFORE scratch erase direction fix (commit 7253f01c). Forward erase of scratch area means partial erase + reboot writes corrupted scratch data back to primary slot, bricking device."
platform: platforms/cortex_m4_flash_fast.repl
bootloader:
  elf: results/oss_validation/assets/oss_mcuboot_scratch_broken.elf
  entry: 0x00000000
memory:
  sram: { start: 0x20000000, end: 0x20040000 }
  write_granularity: 4
  slots:
    exec: { base: 0x0000C000, size: 0x6E000 }
    staging: { base: 0x0007A000, size: 0x6E000 }
# Upgrade scenario: new image in secondary, trigger swap.
# - Primary slot (exec): contains current firmware (slot0 image)
# - Secondary slot (staging): contains new firmware (slot1 image)
# MCUboot will perform swap-using-scratch to install the update.
images:
  exec: results/oss_validation/assets/zephyr_slot0_padded.bin
  staging: results/oss_validation/assets/zephyr_slot1_padded.bin
# Secondary trailer: magic=GOOD to trigger upgrade swap.
# Secondary slot ends at 0x7A000 + 0x6E000 = 0xE8000.
# Trailer magic at 0xE8000 - 16 = 0xE7FF0.
pre_boot_state:
  # Secondary trailer magic (4 words at 0xE7FF0)
  - { address: 0x000E7FF0, u32: 0xF395C277 }
  - { address: 0x000E7FF4, u32: 0x7FEFD260 }
  - { address: 0x000E7FF8, u32: 0x0F505235 }
  - { address: 0x000E7FFC, u32: 0x8079B62C }
success_criteria:
  # After upgrade, primary should have the slot1 image.
  # MCUboot image header version at offset 0x14 from slot base:
  #   slot0 = 0x00000001, slot1 = 0x00010001.
  # Successful upgrade â†’ slot1's version in primary.
  marker_address: 0x0000C014
  marker_value: 0x00010001
fault_sweep:
  mode: runtime
  evaluation_mode: execute
  max_writes: auto
  max_writes_cap: 200000
  run_duration: "2.0"
  max_step_limit: 20000000
  fault_types:
    - power_loss
    - interrupted_erase
skip_self_test: true
expect:
  should_find_issues: true
  brick_rate_min: 0.001
