schema_version: 1
name: mcuboot_pr2199_move_broken
description: >
  MCUboot swap-using-move BEFORE PR #2199 fix (commit 25e2761c).
  Stuck revert: primary has valid image + REVERT trailer state, secondary is
  erased. Broken MCUboot erases secondary trailer but never clears primary
  trailer — REVERT state persists across every boot.

platform: platforms/cortex_m4_flash_fast.repl
bootloader:
  elf: results/oss_validation/assets/oss_mcuboot_pr2199_move_broken.elf
  entry: 0x00000000
memory:
  sram: { start: 0x20000000, end: 0x20040000 }
  write_granularity: 4
  slots:
    exec: { base: 0x0000C000, size: 0x76000 }
    staging: { base: 0x00082000, size: 0x76000 }
# Stuck revert scenario:
# - Primary (exec): valid image + REVERT trailer state
# - Secondary (staging): erased (no image loaded)
images:
  exec: results/oss_validation/assets/zephyr_slot0_padded.bin
# Primary trailer: magic=GOOD, copy_done=SET(0x01), image_ok=UNSET(0xFF).
# This triggers BOOT_SWAP_TYPE_REVERT in boot_swap_tables.
# With no secondary image, MCUboot detects erased secondary but doesn't
# clear the primary REVERT state — stuck.
pre_boot_state:
  # Primary trailer magic (4 words of BOOT_IMG_MAGIC at 0x81FF0)
  - { address: 0x00081FF0, u32: 0xF395C277 }
  - { address: 0x00081FF4, u32: 0x7FEFD260 }
  - { address: 0x00081FF8, u32: 0x0F505235 }
  - { address: 0x00081FFC, u32: 0x8079B62C }
  # Primary copy_done = 0x01 (SET)
  - { address: 0x00081FE0, u32: 0x00000001 }
  # Primary image_ok stays 0xFF (erased/UNSET) — triggers REVERT row
success_criteria:
  vtor_in_slot: exec
  # Check if primary trailer magic was cleared (erased = 0xFFFFFFFF).
  # Broken MCUboot won't clear it — marker mismatch = stuck state detected.
  marker_address: 0x00081FF0
  marker_value: 0xFFFFFFFF
fault_sweep:
  mode: runtime
  evaluation_mode: execute
  max_writes: auto
  max_writes_cap: 200000
  run_duration: "2.0"
  max_step_limit: 20000000
  fault_types: [power_loss, interrupted_erase]
expect:
  # Broken: control boots fine (VTOR ok) but trailer not cleared = wrong_image.
  # All fault points also show wrong_image because primary trailer persists.
  control_outcome: wrong_image
  should_find_issues: true
  brick_rate_min: 0.5
