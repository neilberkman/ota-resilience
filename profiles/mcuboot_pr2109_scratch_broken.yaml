schema_version: 1
name: mcuboot_pr2109_scratch_broken
description: >
  MCUboot swap-scratch BEFORE header reload fix (PR #2109, commit 172694ea).
  After interrupted swap resumes and completes, boot_read_image_headers()
  is called with non-NULL boot_status, causing headers to be read from
  the wrong slots. With different-sized images, this triggers a validation
  failure and unwanted revert — device boots old firmware instead of new.
  Different-sized images (slot0=19KB, slot1=36KB) are required to trigger.

platform: platforms/cortex_m4_flash_fast.repl

bootloader:
  elf: results/oss_validation/assets/oss_mcuboot_pr2109_scratch_broken.elf
  entry: 0x00000000

memory:
  sram: { start: 0x20000000, end: 0x20040000 }
  write_granularity: 4
  slots:
    exec: { base: 0x0000C000, size: 0x6E000 }
    staging: { base: 0x0007A000, size: 0x6E000 }

# Different-sized images — required to trigger the bug.
# slot0 = 19KB, slot1 = 36KB.
images:
  exec: results/oss_validation/assets/zephyr_slot0_padded.bin
  staging: results/oss_validation/assets/zephyr_slot1_large.bin

# Declarative trigger: write GOOD magic to staging slot trailer.
update_trigger:
  type: mcuboot_trailer_magic
  slot: staging

# Image hash: after successful upgrade, exec slot should contain staging image.
# The bug causes unwanted revert → exec slot still has original exec image.
success_criteria:
  vtor_in_slot: exec
  image_hash: true
  expected_image: staging

fault_sweep:
  mode: runtime
  evaluation_mode: execute
  max_writes: auto
  max_writes_cap: 200000
  run_duration: "2.0"
  max_step_limit: 20000000
  fault_types:
    - power_loss
    - interrupted_erase

expect:
  should_find_issues: true
  brick_rate_min: 0.001
