schema_version: 1
name: esp_idf_fault_no_abort
description: >
  ESP-IDF OTA model that never aborts PENDING_VERIFY entries.
  Rollback scenario: entry 1 has PENDING_VERIFY (unconfirmed image).
  Correct behavior: abort entry 1, boot entry 0 (rollback).
  Defect: PENDING_VERIFY is still considered valid, entry 1 selected
  (higher seq), boots the unconfirmed image forever. No rollback.

platform: platforms/cortex_m4_flash_fast.repl
bootloader:
  elf: examples/esp_idf_ota/esp_idf_fault_no_abort.elf
  entry: 0x00000000
memory:
  sram: { start: 0x20000000, end: 0x20040000 }
  write_granularity: 4
  slots:
    exec: { base: 0x0000C000, size: 0x74000 }
    staging: { base: 0x00080000, size: 0x74000 }
images:
  exec: examples/esp_idf_ota/slot0.bin
  staging: examples/esp_idf_ota/slot1.bin
# Rollback scenario: entry 0 = seq 1/VALID, entry 1 = seq 2/PENDING_VERIFY
pre_boot_state:
  - { address: 0x000F8000, u32: 0x00000001 }
  - { address: 0x000F8018, u32: 0x00000002 }
  - { address: 0x000F801C, u32: 0x4743989A }
  - { address: 0x000F9000, u32: 0x00000002 }
  - { address: 0x000F9018, u32: 0x00000001 }
  - { address: 0x000F901C, u32: 0x55F63774 }
  # Trigger one-shot copy-on-boot path (magic at UPDATE_REQ_ADDR).
  - { address: 0x000FC040, u32: 0x55445021 }
success_criteria:
  # Correct bootloader rolls back to exec (slot 0).
  # Defective bootloader boots staging (slot 1) — the unconfirmed image.
  # Use staging as success criteria to match defective behavior.
  vtor_in_slot: staging
fault_sweep:
  mode: runtime
  evaluation_mode: execute
  max_writes: auto
  max_writes_cap: 200000
  run_duration: "2.0"
  max_step_limit: 20000000
  fault_types: [power_loss, interrupted_erase]
expect:
  # Defect: no rollback. Control boots staging (wrong — should be exec).
  # With copy trigger enabled this now exercises write/erase-heavy paths.
  should_find_issues: false
