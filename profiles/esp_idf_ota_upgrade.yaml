schema_version: 1
name: esp_idf_ota_upgrade
description: >
  ESP-IDF OTA bootloader model — upgrade scenario with rollback enabled.
  Implements the exact otadata dual-sector format and state machine from
  ESP-IDF (Apache 2.0). Slot 0 has current image (ota_seq=1, VALID).
  Slot 1 has new image (ota_seq=2, NEW). Bootloader transitions slot 1 to
  PENDING_VERIFY and boots it. Tests power-loss resilience during the
  otadata state transition writes.

platform: platforms/cortex_m4_flash_fast.repl
bootloader:
  elf: examples/esp_idf_ota/esp_idf_ota.elf
  entry: 0x00000000
memory:
  sram: { start: 0x20000000, end: 0x20040000 }
  write_granularity: 4
  slots:
    exec: { base: 0x0000C000, size: 0x74000 }
    staging: { base: 0x00080000, size: 0x74000 }
images:
  exec: examples/esp_idf_ota/slot0.bin
  staging: examples/esp_idf_ota/slot1.bin

# OTAdata at 0xF8000 (sector 0) and 0xF9000 (sector 1).
# Entry format: ota_seq(+0), seq_label(+4, 20B, leave as 0xFF), ota_state(+24), crc(+28)
# Upgrade: entry 0 = seq 1/VALID, entry 1 = seq 2/NEW
pre_boot_state:
  # Entry 0 (sector 0 at 0xF8000): ota_seq=1, VALID
  - { address: 0x000F8000, u32: 0x00000001 }  # ota_seq = 1
  - { address: 0x000F8018, u32: 0x00000002 }  # ota_state = VALID
  - { address: 0x000F801C, u32: 0x4743989A }  # CRC-32 of ota_seq=1
  # Entry 1 (sector 1 at 0xF9000): ota_seq=2, NEW
  - { address: 0x000F9000, u32: 0x00000002 }  # ota_seq = 2
  - { address: 0x000F9018, u32: 0x00000000 }  # ota_state = NEW
  - { address: 0x000F901C, u32: 0x55F63774 }  # CRC-32 of ota_seq=2

# Success = device booted (VTOR relocated to either slot).
# ESP-IDF design: power-loss during NEW→PENDING_VERIFY write gracefully
# rolls back to previous image. Both slots are valid boot targets.
# Control run will boot staging (slot 1); faulted runs may boot either.
success_criteria: {}

fault_sweep:
  mode: runtime
  evaluation_mode: execute
  max_writes: auto
  max_writes_cap: 200000
  run_duration: "2.0"
  max_step_limit: 20000000
  fault_types: [power_loss, interrupted_erase]

expect:
  should_find_issues: false
